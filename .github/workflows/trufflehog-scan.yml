name: TruffleHog Secret Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: write

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog (JSON output)
        run: |
          docker run --rm \
            -v "$PWD":/pwd \
            trufflesecurity/trufflehog:latest git file:///pwd \
            --json > trufflehog-results.json

      - name: Process results and create issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verifica se o arquivo nÃ£o estÃ¡ vazio (tem secrets)
          if [ -s trufflehog-results.json ]; then
            echo "::error::TruffleHog encontrou segredos no repositÃ³rio."
            SUMMARY=$(jq -r -s '
              .[] |
              "ğŸ”´ **Tipo:** " + (.DetectorName // "N/A") + "\n" +
              "ğŸ“ **Arquivo:** " + (.SourceMetadata.Data.Git.file // "N/A") + "\n" +
              "ğŸ“ **Linha:** " + ((.SourceMetadata.Data.Git.line // 0) | tostring) + "\n" +
              "ğŸ”‘ **Commit:** " + (.SourceMetadata.Data.Git.commit // "N/A") + "\n" +
              "ğŸ‘¤ **Autor:** " + (.SourceMetadata.Data.Git.email // "N/A") + "\n" +
              "ğŸ“ **Hash:** " + (.SourceMetadata.Data.Git.file_hash // "N/A") + "\n" +
              "----------------------------------------\n"
            ' trufflehog-results.json)

            BODY_JSON=$(jq -n --arg body "$SUMMARY" '{
                title: "ğŸš¨ TruffleHog detectou segredos no repositÃ³rio",
                body: (
                  "Foram detectados segredos sensÃ­veis no cÃ³digo. Por favor, revogue as credenciais imediatamente.\n\n" +
                  "### Detalhes encontrados:\n\n" +
                  $body +
                  "\n### AÃ§Ãµes recomendadas:\n" +
                  "- ğŸš« **NÃ£o faÃ§a commit** de correÃ§Ãµes apenas removendo o texto (o histÃ³rico mantÃ©m o segredo).\n" +
                  "- ğŸ”„ **Rotacione** (altere) a senha/chave imediatamente.\n" +
                  "- ğŸ§¹ Utilize ferramentas como `git-filter-repo` ou `BFG` para limpar o histÃ³rico se necessÃ¡rio."
                ),
                labels: ["security", "secret", "trufflehog"]
            }')

            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/issues \
              -d "$BODY_JSON"

            exit 1
          else
            echo "âœ… Nenhum segredo encontrado."
          fi